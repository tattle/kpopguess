<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="referrer" content="origin" />
<title>K-Pop MV Guess ‚Äî MVP (Static 20, Token-safe)</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{min-height:100svh;max-width:960px;margin:0 auto;padding:3vw;display:flex;flex-direction:column}
  h1{margin:.2rem 0 .6rem;font-size:clamp(16px,4.5vw,22px)}
  .hud{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:8px}
  .pill{background:#111;border-radius:14px;padding:.7rem 0;text-align:center;font-weight:800;font-size:clamp(12px,3.2vw,15px)}
  .stage{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}
  .mask-top{position:absolute;left:0;right:0;top:0;height:15%;background:#000;pointer-events:none}
  .overlay,.loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center}
  .overlay{background:rgba(0,0,0,.55);z-index:3}
  .overlay button,.btn{border:none;background:#fff;color:#000;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
  .loading{background:rgba(0,0,0,.4);z-index:2}
  .choices{display:grid;gap:10px;margin-top:12px}
  .choice{border:.3vw solid #333;background:#111;color:#fff;border-radius:12px;padding:12px 14px;text-align:left;font-size:clamp(13px,3.2vw,16px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .choice.correct{background:#2e7d32}
  .choice.wrong{background:#b71c1c}
  .bar{display:flex;gap:10px;margin-top:10px;align-items:center}
  .btn:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<div class="wrap">
  <h1>üéµ K-Pop MV Guess ‚Äî 60s</h1>

  <div class="hud">
    <div class="pill">‚è± <span id="time">60</span>s</div>
    <div class="pill">‚úÖ <span id="correct">0</span></div>
    <div class="pill">‚ùì <span id="questions">0</span></div>
  </div>

  <div class="stage">
    <div id="player" style="position:absolute;inset:0"></div>
    <div class="mask-top"></div>
    <div id="loading" class="loading"><div>Loading‚Ä¶</div></div>
    <div id="tap" class="overlay"><button id="tapBtn">Tap to start</button></div>
  </div>

  <div id="choices" class="choices"></div>

  <div class="bar">
    <button id="startBtn" class="btn">Start 60s</button>
  </div>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* ===== Static curated K-pop MV pool (20) =====
   If any ID fails to play/embeds in your region, it will be skipped for that round.
*/
const MV_POOL = [
  {
    "id": "fE2h3lGlOsk",
    "title": "ITZY ‚Äì WANNABE"
  },
  {
    "id": "js1CtxSY38I",
    "title": "ITZY ‚Äì CAKE"
  },
  {
    "id": "sVTy_wmn5SU",
    "title": "NewJeans ‚Äì Super Shy"
  },
  {
    "id": "ArmDp-zijuc",
    "title": "NewJeans ‚Äì OMG"
  },
  {
    "id": "gdZLi9oWNZg",
    "title": "BLACKPINK ‚Äì How You Like That"
  },
  {
    "id": "IHNzOHi8sJs",
    "title": "BLACKPINK ‚Äì DDU-DU DDU-DU"
  },
  {
    "id": "POe9SOEKotk",
    "title": "BLACKPINK ‚Äì Shut Down"
  },
  {
    "id": "WPdWvnAAurg",
    "title": "LE SSERAFIM ‚Äì ANTIFRAGILE"
  },
  {
    "id": "7UqJ2B6V3Fk",
    "title": "LE SSERAFIM ‚Äì UNFORGIVEN"
  },
  {
    "id": "4TWR90KJl84",
    "title": "aespa ‚Äì Spicy"
  },
  {
    "id": "Z8Z51no1TD0",
    "title": "aespa ‚Äì Drama"
  },
  {
    "id": "kOHB85vDuow",
    "title": "TWICE ‚Äì Feel Special"
  },
  {
    "id": "c7rCyll5AeY",
    "title": "TWICE ‚Äì Talk that Talk"
  },
  {
    "id": "i0p1bmr0EmE",
    "title": "TWICE ‚Äì MORE & MORE"
  },
  {
    "id": "eXbu8dD1zNI",
    "title": "IVE ‚Äì I AM"
  },
  {
    "id": "Y8JFxS1HlDo",
    "title": "IVE ‚Äì After LIKE"
  },
  {
    "id": "xoVJKj8lcNQ",
    "title": "IVE ‚Äì LOVE DIVE"
  },
  {
    "id": "pSUydWEqKwE",
    "title": "(G)I-DLE ‚Äì TOMBOY"
  },
  {
    "id": "7GqClqvlObY",
    "title": "(G)I-DLE ‚Äì Queencard"
  },
  {
    "id": "H69tJmsgd9I",
    "title": "IVE ‚Äì Baddie"
  }
];

/* ===== State & utilities ===== */
let player, playerReady=false;
let activeRoundId = 0;       // token to cancel stale rounds
let timeLeft=60, timerId=null;
let totalQuestions=0, totalCorrect=0;
let seenIds = new Set();     // avoid repeats within a run

const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
function setHUD(){ $("time").textContent=timeLeft; $("correct").textContent=totalCorrect; $("questions").textContent=totalQuestions; }
function showLoading(on){ $("loading").style.display = on?"flex":"none"; }
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

/* ===== IFrame API ===== */
function onYouTubeIframeAPIReady(){
  player = new YT.Player("player", {
    host:"https://www.youtube.com",
    width:"100%", height:"100%", videoId:"",
    playerVars:{ origin:location.origin, autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
    events:{
      onReady: () => { playerReady=true; maybeShowTap(); },
      onError: () => { /* don't start a new round here; token logic will handle */ }
    }
  });
}
function maybeShowTap(){
  const isiOS = /(iPhone|iPad|iPod)/i.test(navigator.userAgent);
  if (isiOS) $("tap").style.display="flex";
}

/* ===== Build one question from static pool ===== */
function buildQuestion(){
  // pick 4 distinct ids, preferring ones not seen in this run
  const candidates = shuffle(MV_POOL.filter(v=>!seenIds.has(v.id)));
  const picks = (candidates.length>=4 ? candidates.slice(0,4) : shuffle(MV_POOL).slice(0,4));

  const correct = picks[0];
  const distractors = picks.slice(1);

  // options as objects with a "correct" flag, then shuffle
  const options = shuffle([
    { text: correct.title, correct: true },
    ...distractors.map(v => ({ text: v.title, correct: false }))
  ]);
  const correctIndex = options.findIndex(o => o.correct);

  // random second ~10‚Äì170 (no API duration; keep inside common MV range)
  const t = Math.floor(10 + Math.random() * 160);

  return { rid: activeRoundId, videoId: correct.id, t, options, correctIndex };
}

/* ===== Load & freeze with token-awareness ===== */
async function loadAndFreeze(videoId, t, rid){
  try { player.loadVideoById(videoId); } catch {}
  const start = Date.now();
  while (Date.now() - start < 3500) {
    if (rid !== activeRoundId) return false; // a newer round started
    const st = player.getPlayerState?.();
    if (st === 1 || st === 2){ // PLAYING / PAUSED
      try{
        player.seekTo(t, true);
        setTimeout(()=> { if (rid === activeRoundId) player.pauseVideo(); }, 120);
      }catch{}
      return true;
    }
    try{ player.playVideo(); }catch{}
    await sleep(100);
  }
  return false; // timed out
}

/* ===== Game loop ===== */
function startGame(){
  if (!playerReady){ alert("YouTube is still loading ‚Äî try again in a moment."); return; }
  $("tap").style.display="none";
  seenIds.clear();
  totalQuestions=0; totalCorrect=0; timeLeft=60; setHUD();
  if (timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--; setHUD();
    if (timeLeft<=0){
      clearInterval(timerId); timerId=null;
      alert(`Time's up! ‚úÖ Correct: ${totalCorrect} / Questions: ${totalQuestions}`);
    }
  }, 1000);
  nextRound();
}

async function nextRound(){
  if (timeLeft<=0) return;
  const rid = ++activeRoundId;       // new token for this round
  showLoading(true);

  // Build question FIRST (prevents mismatches)
  const q = buildQuestion();

  // Render choices immediately for this token
  renderChoices(q);

  // Load the correct MV and freeze at t
  const ok = await loadAndFreeze(q.videoId, q.t, rid);
  showLoading(false);

  if (!ok || rid !== activeRoundId) return; // cancelled or failed
  totalQuestions++; setHUD();
  seenIds.add(q.videoId);
}

/* ===== Render & answer (auto-advance) ===== */
function renderChoices(q){
  const box = $("choices");
  box.innerHTML="";
  q.options.forEach((opt, i)=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = `${String.fromCharCode(65+i)}. ${opt.text}`;
    btn.onclick = () => {
      // ignore clicks from stale rounds
      if (q.rid !== activeRoundId) return;

      const buttons = [...document.querySelectorAll(".choice")];
      buttons.forEach(b=> b.disabled=true);

      if (opt.correct){
        totalCorrect++;
        btn.classList.add("correct");
      }else{
        btn.classList.add("wrong");
        const okBtn = buttons[q.options.findIndex(o=>o.correct)];
        if (okBtn) okBtn.classList.add("correct");
      }
      setHUD();

      // auto-advance after a short highlight
      setTimeout(()=>{ if (q.rid === activeRoundId && timeLeft>0) nextRound(); }, 700);
    };
    box.appendChild(btn);
  });
}

/* ===== UI ===== */
$("startBtn").onclick = () => startGame();
$("tapBtn").onclick   = () => startGame();
</script>
</body>
</html>
