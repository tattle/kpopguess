<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="referrer" content="origin" />
<title>K-Pop MV Guess ‚Äî No-API MVP</title>
<style>
  :root{ --r:14px; }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{ min-height:100svh; max-width:960px; margin:0 auto; padding:3vw; display:flex; flex-direction:column; }
  h1{ margin:.2rem 0 1rem; font-size:clamp(16px,4.5vw,22px) }
  .hud{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:10px }
  .pill{ background:#111; border-radius:999px; text-align:center; padding:10px 12px; font-weight:800; font-size:clamp(12px,3.2vw,15px) }

  .stage{ position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden }
  #player{ position:absolute; inset:0 }
  .mask-top{ position:absolute; left:0; right:0; top:0; height:15%; background:#000; pointer-events:none }
  .overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:3 }
  .overlay button{ border:none; background:#fff; color:#000; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer; font-size:clamp(16px,4.2vw,20px)}

  .choices{ display:grid; gap:10px; margin-top:12px }
  .choice{ border:none; background:#1a1a1a; color:#fff; border-radius:12px; padding:12px 14px; text-align:left; font-size:clamp(13px,3.2vw,16px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border:1px solid #333; }
  .choice:disabled{ opacity:.85 }
  .choice.correct{ background:#2e7d32 }
  .choice.wrong{ background:#b71c1c }

  .bar{ display:flex; gap:12px; margin-top:10px; }
  .btn{ border:none; background:#fff; color:#000; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer; }
  .btn:disabled{ opacity:.65; cursor:not-allowed }
</style>
</head>
<body>
<div class="wrap">
  <h1>üéµ K-Pop MV Guess ‚Äî MVP</h1>

  <div class="hud">
    <div class="pill">‚è± <span id="time">60</span>s</div>
    <div class="pill">‚úÖ <span id="correct">0</span></div>
    <div class="pill">‚ùì <span id="questions">0</span></div>
  </div>

  <div class="stage">
    <div id="player"></div>
    <div class="mask-top"></div>
    <div id="tap" class="overlay"><button id="tapBtn">Tap to start</button></div>
  </div>

  <div id="choices" class="choices"></div>

  <div class="bar">
    <button id="startBtn" class="btn">Start 60s</button>
    <button id="nextBtn" class="btn" disabled>Next</button>
  </div>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* ====== Fallback K-Pop pool (no API required) ====== */
const MV_POOL = [
  {id:"IHNzOHi8sJs", title:"BLACKPINK ‚Äì DDU-DU DDU-DU"},
  {id:"gdZLi9oWNZg", title:"BLACKPINK ‚Äì How You Like That"},
  {id:"gOsM-DYAEhY", title:"TWICE ‚Äì Feel Special"},
  {id:"fE2h3lGlOsk", title:"ITZY ‚Äì WANNABE"},
  {id:"eXbu8dD1zNI", title:"IVE ‚Äì I AM"},
  {id:"sVTy_wmn5SU", title:"NewJeans ‚Äì Super Shy"},
  {id:"wTOP-nRZ5Jk", title:"SEVENTEEN ‚Äì Super"},
  {id:"WPdWvnAAurg", title:"LE SSERAFIM ‚Äì ANTIFRAGILE"},
  {id:"ry3S5H3p8wE", title:"aespa ‚Äì Savage"},
  {id:"_bw4Z8VQGDY", title:"(G)I-DLE ‚Äì Nxde"},
  {id:"pSU6Z2Zf0_0", title:"BTS ‚Äì Dynamite"},
  {id:"Vi7qH-LEhWU", title:"Stray Kids ‚Äì LALALALA"},
];

/* ====== Minimal state ====== */
let player, ready=false, userGesture=false;
let timeLeft=60, timerId=null;
let totalCorrect=0, totalQuestions=0;
let current=null; // {videoId,title,t,options[],correctIndex}
let recent=[]; const RECENT_MAX=40;

const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const shuffle = a => { const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; };
const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
function setHUD(){ $("time").textContent=timeLeft; $("correct").textContent=totalCorrect; $("questions").textContent=totalQuestions; }
function pushRecent(id){ recent.push(String(id)); if(recent.length>RECENT_MAX) recent.shift(); }

/* ====== YouTube IFrame setup ====== */
function onYouTubeIframeAPIReady(){
  player = new YT.Player("player", {
    host:"https://www.youtube.com",
    width:"100%", height:"100%", videoId:"",
    playerVars:{ origin: location.origin, autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
    events:{
      onReady: ()=>{ ready=true; maybeShowTap(); },
      onError: ()=>{ // skip bad video
        nextQuestion();
      }
    }
  });
}

function maybeShowTap(){
  const isiOS = /(iPhone|iPad|iPod)/i.test(navigator.userAgent);
  if (isiOS && !userGesture) $("tap").style.display="flex";
}

/* ====== 1) Build a question: pick MV, random second, pause ====== */
function pickMV(){
  // avoid immediate repeats
  const pool = MV_POOL.filter(v=> !recent.includes(v.id));
  if (!pool.length) pool.push(...MV_POOL);
  const correct = pool[Math.floor(Math.random()*pool.length)];
  pushRecent(correct.id);

  // 3 fake options
  const others = shuffle(MV_POOL.filter(x=>x.id!==correct.id)).slice(0,3).map(x=>x.title);
  const options = shuffle([correct.title, ...others]);
  const correctIndex = options.findIndex(t => t === correct.title);

  // pick a random second within 5%~95% (assume common MV length ‚âà 3:00 ‚Üí 180s fallback)
  const estDuration = 180; // no API, so we estimate; still looks random enough
  const start = Math.floor(estDuration * 0.05);
  const end   = Math.ceil (estDuration * 0.95);
  const t = clamp(Math.floor(start + Math.random()*(end-start)), 1, estDuration-1);

  return { videoId:correct.id, title:correct.title, t, options, correctIndex };
}

/* Load, jump, and pause */
async function loadAndFreeze(q){
  try { player.loadVideoById(q.videoId); } catch {}
  // Nudge play on iOS, then seek and pause
  for (let i=0;i<30;i++){
    const s = player.getPlayerState?.();
    if (s === 1 || s === 2){ // playing or paused
      try{
        player.seekTo(q.t, true);
        setTimeout(()=> player.pauseVideo(), 120);
      }catch{}
      return true;
    }
    try{ player.playVideo(); }catch{}
    await sleep(100);
  }
  return false;
}

/* ====== 2) Render options & handle answer ====== */
function renderChoices(q){
  const box = $("choices");
  box.innerHTML = "";
  q.options.forEach((title, i)=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = `${String.fromCharCode(65+i)}. ${title}`;
    btn.onclick = ()=> choose(i, btn);
    box.appendChild(btn);
  });
  $("nextBtn").disabled = true;
}

function choose(i, btn){
  // disable all
  [...document.querySelectorAll(".choice")].forEach(b=> b.disabled=true);
  if (i === current.correctIndex){
    totalCorrect++;
    btn.classList.add("correct");
  }else{
    btn.classList.add("wrong");
    const okBtn = document.querySelectorAll(".choice")[current.correctIndex];
    okBtn.classList.add("correct");
  }
  setHUD();
  $("nextBtn").disabled = false;
}

/* ====== 3) 60s game loop ====== */
function startGame(){
  if (!ready){ alert("YouTube is loading, try again."); return; }
  userGesture = true;
  $("tap").style.display="none";

  // reset stats & timer
  timeLeft = 60; totalCorrect = 0; totalQuestions = 0; setHUD();
  if (timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--; setHUD();
    if (timeLeft <= 0){
      clearInterval(timerId); timerId=null;
      alert(`Time's up!\nCorrect: ${totalCorrect}\nQuestions: ${totalQuestions}`);
      $("nextBtn").disabled = true;
    }
  }, 1000);

  nextQuestion();
}

async function nextQuestion(){
  if (timeLeft <= 0) return;
  current = pickMV();
  totalQuestions++; setHUD();

  // load & freeze random frame
  const ok = await loadAndFreeze(current);
  if (!ok){ // if failed to control playback, try another quickly
    return nextQuestion();
  }
  renderChoices(current);
}

/* ====== UI Events ====== */
$("startBtn").onclick = () => startGame();
$("nextBtn").onclick  = () => nextQuestion();
$("tapBtn").onclick   = () => { userGesture = true; $("tap").style.display="none"; startGame(); };
</script>
</body>
</html>
