<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>K-Pop Guess ¬∑ Auto Start (Embeddable Safe)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
  :root{ --gap:12px; --r:14px; }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:#fff; color:#111; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Arial,"PingFang TC","Heiti TC","Microsoft JhengHei",sans-serif; }
  .wrap{ height:100svh; display:flex; flex-direction:column; padding: 2.4vw; max-width: 960px; margin: 0 auto; }
  h1{ font-size: clamp(16px,4.4vw,20px); margin:0 0 .8vh 0; }

  .hud{ display:grid; grid-template-columns:repeat(4,1fr); gap:min(1.0vw,8px); margin-top:.9vh; }
  .pill{ background:#111; color:#fff; text-align:center; font-weight:800; border-radius:2.6vw;
         padding:.9vh .6vw; font-size:clamp(12px,3.0vw,15px); line-height:1.05; }

  .stage{ position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius: 3vw; margin-top: 1.0vh; overflow:hidden; }
  .mask-top{ position:absolute; left:0; right:0; top:0; height:15%; background:#000; pointer-events:none; }
  .loading{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; color:#fff; background:rgba(0,0,0,.25); font-size:clamp(14px,3.4vw,18px); }
  .tapstart{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
  .tapstart button{ font-size:clamp(16px,4.2vw,20px); padding:1.2vh 2.4vw; border-radius:14px; border:none; background:#fff; }

  .choices{ display:grid; gap:.9vh; margin-top:.9vh; }
  .choice{ text-align:left; border:.35vw solid #ccc; background:#111; color:#fff; border-radius:3.2vw;
           font-size:clamp(13px,3.2vw,16px); padding:1.2vh 1.6vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .choice.correct{ background:#2e7d32; }
  .choice.wrong{ background:#b71c1c; }

  .foot{ display:flex; gap:min(2vw,12px); margin-top:.8vh; }
  .btn{ border:none; background:#111; color:#fff; cursor:pointer; border-radius:var(--r); padding:1.0vh 1.4vw; font-size:clamp(13px,3.2vw,16px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
</style>
</head>
<body>
<div class="wrap">
  <h1>üéµ K-Pop GuessÔºàAuto StartÔºâ</h1>

  <div class="hud">
    <div class="pill" id="hudTime">‚è± 60s</div>
    <div class="pill" id="hudScore">‚≠ê 0</div>
    <div class="pill" id="hudCount">üìä 0 È°å</div>
    <div class="pill" id="hudAcc">üéØ 0%</div>
  </div>

  <div class="stage">
    <div id="player" style="position:absolute; inset:0;"></div>
    <div class="mask-top"></div>
    <div id="loading" class="loading">Âá∫È°å‰∏≠‚Ä¶</div>
    <div id="tapstart" class="tapstart"><button id="tapBtn">Èªû‰∏Ä‰∏ãÈñãÂßã</button></div>
  </div>

  <div id="choices" class="choices"></div>

  <div class="foot">
    <button id="nextBtn" class="btn" disabled>‰∏ã‰∏ÄÈ°å</button>
    <button id="restartBtn" class="btn" style="display:none;">ÂÜçÁé©‰∏ÄÊ¨°</button>
  </div>
</div>

<script>
/* ‰Ω†ÁöÑ YouTube Data API v3 KeyÔºàË´ãÂú® GCP Â∞á HTTP ‰æÜÊ∫êÈôêÂà∂Âà∞‰Ω†ÁöÑÁ∂≤ÂüüÔºâ */
const YT_API_KEY = "YOUR_YOUTUBE_API_KEY_HERE";

/* ===== ÁãÄÊÖã ===== */
let player, ytReady=false, playerReady=false, userGestureOK=false;
let score=0, qCount=0, correctCount=0, wrongCount=0;
let timeLeft=60, timer=null, gameOver=false;
let current=null; // {videoId, t, choices[], correctIndex, answerTitle, duration}
let seen=[];     // ÊúÄËøë 40 È°åÁöÑ videoId

/* ===== ÂãïÊÖãËºâÂÖ• IFrame API ===== */
function loadIframeAPI() {
  return new Promise((resolve) => {
    if (window.YT && window.YT.Player) return resolve();
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    window.onYouTubeIframeAPIReady = () => resolve();
    document.head.appendChild(tag);
  });
}

/* ===== ÂàùÂßãÂåñ PlayerÔºàÂ∏∂ origin/host„ÄÅÊéõ onError Ëá™ÂãïÊèõÈ°åÔºâ ===== */
async function initPlayer(){
  await loadIframeAPI();
  ytReady = true;
  player = new YT.Player("player", {
    width:"100%", height:"100%", videoId:"",
    host: "https://www.youtube.com",
    playerVars:{
      origin: location.origin,
      controls:0, modestbranding:1, rel:0, playsinline:1, fs:0, disablekb:1, iv_load_policy:3
    },
    events:{
      onReady: () => {
        playerReady = true;
        try { player.mute(); } catch {}
        tryStartGame();
      },
      onError: (e) => {
        console.warn("YT onError", e?.data);
        // 2„ÄÅ5„ÄÅ101„ÄÅ150 ‚Üí Áõ¥Êé•Êèõ‰∏ã‰∏ÄÈ°å
        if ([2,5,101,150].includes(e?.data)) {
          // Ëá™ÂãïË∑≥‰∏ã‰∏ÄÈ°åÔºåÈÅøÂÖçÊï¥Â±ÄÂç°Ê≠ª
          startRound();
        }
      }
    }
  });
}

/* ===== Â∑•ÂÖ∑ ===== */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const norm  = (s="")=>s.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"");
const shuffle = (arr)=>{ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; };
const updateHUD = ()=>{
  document.getElementById("hudTime").textContent = `‚è± ${timeLeft}s`;
  document.getElementById("hudScore").textContent = `‚≠ê ${score}`;
  document.getElementById("hudCount").textContent = `üìä ${qCount} È°å`;
  const acc = qCount? Math.round((correctCount/qCount)*100):0;
  document.getElementById("hudAcc").textContent = `üéØ ${acc}%`;
};
const showLoading = (on)=> document.getElementById("loading").style.display = on?"flex":"none";
const pushSeen = (vid)=>{ seen.push(String(vid)); if(seen.length>40) seen.shift(); };

/* ===== Ëá™ÂãïÈñãÂßãÊ¢ù‰ª∂ ===== */
function tryStartGame(){
  if (playerReady) {
    const isiOS = /(iPhone|iPad|iPod)/i.test(navigator.userAgent);
    if (!isiOS) {
      startGame();
    } else {
      // ÂòóË©¶Ëá™ÂãïÈñãÂßãÔºõËã•‰ªçË¢´ÈòªÊìãÔºå1 ÁßíÂæåÈ°ØÁ§∫„ÄåÈªû‰∏Ä‰∏ãÈñãÂßã„Äç
      startGame(true);
      setTimeout(()=>{
        const st = player.getPlayerState?.();
        if (st !== 1 && st !== 2) {
          document.getElementById("tapstart").style.display = "flex";
        }
      }, 1000);
    }
  }
}

/* ===== ÂèñÈ°åÔºàÂè™ÂèñÂèØÂ§ñÂµå/ÂèØËÅØÊí≠Ôºå‰∏¶ÈÅéÊøæÂú∞ÂçÄÈôêÂà∂Ôºâ ===== */
async function fetchRound(){
  // Âõ∫ÂÆö‰∏ªÈ°åÔºöK-Pop ÂÆòÊñπ MVÔºà‰∏≠/Èüì/Ëã±Ê∑∑ÂêàÈóúÈçµË©ûÔºâ
  const q = "K-Pop official MV Í≥µÏãù ÎÆ§ÏßÅÎπÑÎîîÏò§ ÏïÑÏù¥Îèå K-POP";
  const searchURL = new URL("https://www.googleapis.com/youtube/v3/search");
  searchURL.searchParams.set("key", YT_API_KEY);
  searchURL.searchParams.set("part", "snippet");
  searchURL.searchParams.set("type", "video");
  searchURL.searchParams.set("videoCategoryId", "10");
  searchURL.searchParams.set("maxResults", "30");
  searchURL.searchParams.set("safeSearch", "moderate");
  searchURL.searchParams.set("regionCode", "KR");
  searchURL.searchParams.set("relevanceLanguage", "ko");
  searchURL.searchParams.set("q", q);
  // Âè™ÂèñËÉΩÂµåÂÖ•/ËÉΩÂú® youtube.com ‰ª•Â§ñÊí≠ÊîæÁöÑÂΩ±Áâá
  searchURL.searchParams.set("videoEmbeddable", "true");
  searchURL.searchParams.set("videoSyndicated", "true");
  searchURL.searchParams.set("fields", "items(id/videoId,snippet/title,snippet/description,snippet/channelTitle)");

  const sRes = await fetch(searchURL.toString());
  if (!sRes.ok) throw new Error("YouTube search failed");
  const sJson = await sRes.json();

  let prelim = (sJson.items||[]).map(i=>({
    id:i.id?.videoId, title:i.snippet?.title||"", desc:i.snippet?.description||"", channel:i.snippet?.channelTitle||""
  })).filter(v=>v.id && !seen.includes(v.id));

  // Á≤óÈÅéÊøæÔºöÁúãËµ∑‰æÜÂÉè MVÔºàÈÅøÂÖçÊ≠åË©û/ÁèæÂ†¥/Áü≠ÁâáÔºâ
  const looksLikeMV = (title="",desc="",channel="")=>{
    const INCLUDE = /(official(?!\s*audio)|music\s*video|mv|Í≥µÏãù|ÎÆ§ÏßÅÎπÑÎîîÏò§|ÂÆòÊñπ|ÂÆåÊï¥Áâà)/i.test(title)
                 || /(official(?!\s*audio)|music\s*video|mv|Í≥µÏãù|ÎÆ§ÏßÅÎπÑÎîîÏò§|ÂÆòÊñπ)/i.test(desc)
                 || /official|vevo/i.test(channel);
    const EX = /(lyric|lyrics|Ê≠åË©û|ÏûêÎßâ|dance|practice|mirror|cover|reaction|reac|live|ÁèæÂ†¥|ËàûÂè∞|ÏßÅÏ∫†|fancam|teaser|trailer|audio|visualizer|shorts|topic)/i;
    return INCLUDE && !EX.test(title) && !EX.test(desc) && !/topic/i.test(channel);
  };
  prelim = prelim.filter(v=>looksLikeMV(v.title,v.desc,v.channel));
  if(!prelim.length) throw new Error("Ê≤íÊúâÂêàÈÅ©ÁöÑ MVÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°");

  // ÂèñÂΩ±ÁâáÈï∑Â∫¶ + ÁãÄÊÖãÔºàembeddable / regionRestrictionÔºâ
  const ids = prelim.map(v=>v.id).join(",");
  const videosURL = new URL("https://www.googleapis.com/youtube/v3/videos");
  videosURL.searchParams.set("key", YT_API_KEY);
  videosURL.searchParams.set("part", "contentDetails,snippet,status");
  videosURL.searchParams.set("id", ids);
  videosURL.searchParams.set("fields", "items(id,contentDetails/duration,contentDetails/regionRestriction,status/embeddable,snippet/title,snippet/channelTitle)");
  const vRes = await fetch(videosURL.toString());
  if (!vRes.ok) throw new Error("videos lookup failed");
  const vJson = await vRes.json();

  const isoToSec = (iso)=>{
    const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    if(!m) return 0; const h=+(m[1]||0), M=+(m[2]||0), s=+(m[3]||0); return h*3600+M*60+s;
  };
  const myCC = (Intl?.DateTimeFormat?.().resolvedOptions?.().locale || "en-US").split("-").pop()?.toUpperCase() || "TW";

  let all = (vJson.items||[]).map(v=>{
    const dur = isoToSec(v.contentDetails?.duration||"PT0S");
    const rr = v.contentDetails?.regionRestriction || {};
    const emb = v.status?.embeddable !== false;
    // Âú∞ÂçÄÈÅéÊøæÔºöËã• blocked Âê´ÊàëÊâÄÂú®ÂúãÂÆ∂ ‚Üí ÊéíÈô§ÔºõËã• allowed Â≠òÂú®‰∏î‰∏çÂê´ÊàëÂúãÂÆ∂ ‚Üí ÊéíÈô§
    const blocked = Array.isArray(rr.blocked) ? rr.blocked : [];
    const allowed = Array.isArray(rr.allowed) ? rr.allowed : null;
    const regionOK = (!blocked.includes(myCC)) && (!allowed || allowed.includes(myCC));
    return { id:v.id, duration:dur, title:v.snippet?.title||"", channel:v.snippet?.channelTitle||"", embeddable: emb, regionOK };
  })
  .filter(x=>x.duration>=120 && x.embeddable && x.regionOK);

  if(!all.length) throw new Error("Êö´ÁÑ°ÂèØÂ§ñÂµå‰∏îÂú®‰Ω†Âú∞ÂçÄÂèØÊí≠ÊîæÁöÑ MV");

  // Ê≠£Ëß£ + 3 Âπ≤ÊìæÔºàÂè™Áî®„ÄåÊ®ôÈ°å„ÄçÔºâ
  const pick = all[Math.floor(Math.random()*all.length)];
  const answerTitle = pick.title;
  const normKey = (t,a)=>`${norm(t)}|${norm(a)}`;
  const target = normKey(pick.title, pick.channel);

  const pool = all.slice(0,24);
  const seenKey = new Set(), dist = [];
  const pushU = (arr)=>{ for(const c of arr){ const k=normKey(c.title,c.channel); if(k===target||seenKey.has(k)) continue; seenKey.add(k); dist.push(c.title); if(dist.length>=3) break; } };
  pushU(shuffle(pool));
  if(dist.length<3) pushU(all);
  if(dist.length<3) throw new Error("Âπ≤ÊìæÈÅ∏È†Ö‰∏çË∂≥");

  const choices = shuffle([answerTitle, ...dist.slice(0,3)]);
  const correctIndex = choices.findIndex(t=>norm(t)===norm(answerTitle));

  // ÊäΩÊ®£ÁßíÊï∏Ôºà5%~95%Ôºâ
  const start = Math.floor(pick.duration*0.05);
  const end   = Math.ceil(pick.duration*0.95);
  const t = clamp(Math.floor(start + Math.random()*(end-start)), 1, Math.max(1,pick.duration-1));

  return { videoId:pick.id, t, duration:pick.duration, answerTitle, choices, correctIndex };
}

/* ===== Âá∫È°å ===== */
async function startRound(){
  if(gameOver) return;
  showLoading(true);
  try{
    const data = await fetchRound();
    current = data; qCount++; updateHUD(); pushSeen(data.videoId);

    player.loadVideoById(data.videoId);
    let controlled = false;
    for(let i=0;i<30;i++){
      const st = player.getPlayerState?.();
      if(st === 1 || st === 2){ // PLAYING / PAUSED
        player.seekTo(data.t, true);
        setTimeout(()=> player.pauseVideo(), 120);
        controlled = true;
        break;
      }
      try{ player.playVideo(); }catch{}
      await sleep(100);
    }
    if (!controlled && !userGestureOK) {
      document.getElementById("tapstart").style.display = "flex";
    }

    renderChoices();
    document.getElementById("nextBtn").disabled = true;
  }catch(e){
    console.error(e);
    alert(e.message || "Âá∫È°åÂ§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶");
  }finally{
    showLoading(false);
  }
}

/* ===== ÂõõÈÅ∏‰∏Ä ===== */
function renderChoices(){
  const el = document.getElementById("choices");
  el.innerHTML = "";
  current.choices.forEach((title, idx)=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = `${String.fromCharCode(65+idx)}. ${title}`;
    btn.title = title;
    btn.onclick = () => choose(idx, btn);
    el.appendChild(btn);
  });
}

/* ===== ‰ΩúÁ≠îÔºöÂç≥Âà§ÂàÜ ===== */
function choose(idx, btn){
  [...document.querySelectorAll(".choice")].forEach(b=> b.disabled = true);
  const correct = (idx === current.correctIndex);
  if(correct){ score += 100; correctCount++; btn.classList.add("correct"); }
  else{
    wrongCount++; btn.classList.add("wrong");
    const okBtn = document.querySelectorAll(".choice")[current.correctIndex];
    okBtn.classList.add("correct");
  }
  updateHUD();
  document.getElementById("nextBtn").disabled = false;
}

/* ===== ÈÅäÊà≤ÊéßÂà∂ ===== */
function startGame(silent=false){
  score=0; qCount=0; correctCount=0; wrongCount=0; timeLeft=60; gameOver=false;
  updateHUD();
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    timeLeft--; updateHUD();
    if(timeLeft<=0){
      clearInterval(timer); timer=null; gameOver=true;
      alert(`ÊôÇÈñìÂà∞ÔºÅÂàÜÊï∏ ${score}ÔΩúÈ°åÊï∏ ${qCount}ÔΩúÊ≠£Á¢∫ ${correctCount}ÔΩúÈåØË™§ ${wrongCount}`);
      document.getElementById("restartBtn").style.display = "inline-block";
    }
  },1000);
  if (!silent) document.getElementById("restartBtn").style.display = "none";
  startRound();
}

/* ===== ‰∫ã‰ª∂Á∂ÅÂÆö ===== */
document.getElementById("nextBtn").onclick  = () => startRound();
document.getElementById("restartBtn").onclick = () => { startGame(); };
document.getElementById("tapBtn").onclick = () => {
  userGestureOK = true;
  document.getElementById("tapstart").style.display = "none";
  try { player.playVideo(); } catch{}
  startRound();
};

/* ===== ÂïüÂãï ===== */
initPlayer().then(() => tryStartGame());
</script>
</body>
</html>
