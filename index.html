<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="referrer" content="origin" />
<title>K-Pop Random MV Player</title>
<style>
  *{box-sizing:border-box} html,body{margin:0;padding:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{min-height:100svh;display:flex;flex-direction:column;max-width:960px;margin:0 auto;padding:3vw}
  h1{margin:.2rem 0 1rem;font-size:clamp(16px,4.5vw,22px)}
  .stage{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}
  .mask-top{position:absolute;left:0;right:0;top:0;height:15%;background:#000;pointer-events:none}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2}
  .overlay button,.bar button{border:none;background:#fff;color:#000;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
  .loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:1}
  .bar{display:flex;gap:12px;margin-top:10px}
  .msg{opacity:.8;font-size:.9rem;margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸŽµ K-Pop Random MV Player</h1>

  <div class="stage">
    <div id="player" style="position:absolute;inset:0"></div>
    <div class="mask-top"></div>
    <div id="loading" class="loading"><div>Loadingâ€¦</div></div>
    <div id="tap" class="overlay"><button id="tapBtn">Tap to start</button></div>
  </div>

  <div class="bar">
    <button id="nextBtn">Next MV</button>
    <span id="title" class="msg"></span>
  </div>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/** 1) Put your YouTube Data API v3 key here **/
const YT_API_KEY = "AIzaSyDBB3J-vwLYe8Enbmi6SmNCB5NW4QJv5Dc";

/** 2) Minimal state **/
let player, ready=false, userGesture=false;
let recent = []; const RECENT_MAX = 40;
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const shuffle = a => {const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]} return x;};
function showLoading(on){ $("loading").style.display = on ? "flex" : "none"; }
function pushRecent(id){ recent.push(String(id)); if(recent.length>RECENT_MAX) recent.shift(); }

/** 3) Fallback pool (used if API fails) **/
const FALLBACK = shuffle([
  {id:"IHNzOHi8sJs", title:"BLACKPINK â€“ DDU-DU DDU-DU"},
  {id:"gdZLi9oWNZg", title:"BLACKPINK â€“ How You Like That"},
  {id:"gOsM-DYAEhY", title:"TWICE â€“ Feel Special"},
  {id:"fE2h3lGlOsk", title:"ITZY â€“ WANNABE"},
  {id:"eXbu8dD1zNI", title:"IVE â€“ I AM"},
  {id:"sVTy_wmn5SU", title:"NewJeans â€“ Super Shy"},
  {id:"wTOP-nRZ5Jk", title:"SEVENTEEN â€“ Super"},
  {id:"WPdWvnAAurg", title:"LE SSERAFIM â€“ ANTIFRAGILE"},
  {id:"ry3S5H3p8wE", title:"aespa â€“ Savage"}
]);

/** 4) IFrame API hook **/
function onYouTubeIframeAPIReady(){
  player = new YT.Player("player", {
    host: "https://www.youtube.com",
    width:"100%", height:"100%",
    videoId:"",
    playerVars:{
      origin: location.origin,
      autoplay: 1, mute: 1, // mute allows autoplay on iOS
      playsinline: 1, controls: 1, rel: 0, modestbranding: 1
    },
    events:{
      onReady: () => { ready = true; maybeAutostart(); },
      onError: () => { // skip problematic video
        playRandomFromFallback();
      }
    }
  });
}

/** 5) Try to autoplay; on iOS show tap overlay **/
function maybeAutostart(){
  const isiOS = /(iPhone|iPad|iPod)/i.test(navigator.userAgent);
  if (isiOS && !userGesture) {
    $("tap").style.display = "flex";
  } else {
    nextRandom();
  }
}

/** 6) Fetch a random K-Pop MV (embeddable, non-shorts); fallback if needed **/
async function fetchRandomKpop(){
  // Broad query to maximize success
  const u = new URL("https://www.googleapis.com/youtube/v3/search");
  u.searchParams.set("key", YT_API_KEY);
  u.searchParams.set("part","snippet");
  u.searchParams.set("type","video");
  u.searchParams.set("maxResults","50");
  u.searchParams.set("videoEmbeddable","true");
  u.searchParams.set("videoSyndicated","true");
  u.searchParams.set("videoDuration","medium,long");
  u.searchParams.set("q","K-Pop official MV ê³µì‹ ë®¤ì§ë¹„ë””ì˜¤ ì•„ì´ëŒ K-POP");

  let sJson;
  try{
    const res = await fetch(u.toString());
    if(!res.ok) throw new Error("search HTTP "+res.status);
    sJson = await res.json();
  }catch(e){
    console.warn("search failed:", e);
    return null;
  }

  // Basic MV heuristics
  const looksLikeMV = (t="",d="",c="")=>{
    const IN = /(official(?!\s*audio)|music\s*video|mv|ê³µì‹|ë®¤ì§ë¹„ë””ì˜¤|å®˜æ–¹|å®Œæ•´ç‰ˆ)/i.test(t)
            || /(official(?!\s*audio)|music\s*video|mv|ê³µì‹|ë®¤ì§ë¹„ë””ì˜¤|å®˜æ–¹)/i.test(d)
            || /official|vevo/i.test(c);
    const EX = /(lyric|lyrics|æ­Œè©ž|ìžë§‰|dance|practice|mirror|cover|reaction|live|ç¾å ´|èˆžå°|ì§ìº |fancam|teaser|trailer|audio|visualizer|shorts|topic)/i;
    return IN && !EX.test(t) && !EX.test(d) && !/topic/i.test(c);
  };

  let prelim = (sJson.items||[])
    .map(i=>({ id:i.id?.videoId, title:i.snippet?.title||"", desc:i.snippet?.description||"", ch:i.snippet?.channelTitle||"" }))
    .filter(v => v.id && !recent.includes(v.id) && looksLikeMV(v.title,v.desc,v.ch));

  if (!prelim.length) return null;

  // Confirm playable & duration
  const ids = prelim.map(v=>v.id).join(",");
  const v = new URL("https://www.googleapis.com/youtube/v3/videos");
  v.searchParams.set("key", YT_API_KEY);
  v.searchParams.set("part","contentDetails,status,snippet,contentRating");
  v.searchParams.set("id", ids);

  try{
    const res = await fetch(v.toString());
    if(!res.ok) throw new Error("videos HTTP "+res.status);
    const j = await res.json();

    const isoToSec = iso => {const m=(iso||"").match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if(!m)return 0; return (+m[1]||0)*3600+(+m[2]||0)*60+(+m[3]||0);}
    const myCC = (Intl?.DateTimeFormat?.().resolvedOptions?.().locale||"en-US").split("-").pop()?.toUpperCase() || "TW";

    let pool = (j.items||[]).map(x=>{
      const dur = isoToSec(x.contentDetails?.duration);
      const rr = x.contentDetails?.regionRestriction || {};
      const emb = x.status?.embeddable !== false;
      const age = (x.contentRating?.ytRating||"") === "ytAgeRestricted";
      const blocked = Array.isArray(rr.blocked)? rr.blocked : [];
      const allowed = Array.isArray(rr.allowed)? rr.allowed : null;
      const regionOK = (!blocked.includes(myCC)) && (!allowed || allowed.includes(myCC));
      return { id:x.id, title:x.snippet?.title||"", embeddable:emb, regionOK, age, duration:dur };
    }).filter(z => z.embeddable && z.regionOK && !z.age && z.duration >= 120);

    if (!pool.length) return null;
    return pool[Math.floor(Math.random()*pool.length)];
  }catch(e){
    console.warn("videos failed:", e);
    return null;
  }
}

/** 7) Playback helpers **/
async function nextRandom(){
  if (!ready) return;
  showLoading(true);
  $("title").textContent = "";
  try{
    let pick = await fetchRandomKpop();
    if (!pick) {
      // Fallback
      pick = FALLBACK.find(v => !recent.includes(v.id)) || FALLBACK[Math.floor(Math.random()*FALLBACK.length)];
    }
    player.loadVideoById(pick.id);
    $("title").textContent = pick.title || "K-Pop MV";
    pushRecent(pick.id);

    // Nudge play on iOS until it starts
    for (let i=0;i<30;i++){
      const s = player.getPlayerState?.();
      if (s === 1) break;      // PLAYING
      try{ player.playVideo(); }catch{}
      await sleep(100);
    }
  }finally{
    showLoading(false);
  }
}

function playRandomFromFallback(){
  const pick = FALLBACK.find(v => !recent.includes(v.id)) || FALLBACK[Math.floor(Math.random()*FALLBACK.length)];
  $("title").textContent = pick.title;
  pushRecent(pick.id);
  try { player.loadVideoById(pick.id); } catch {}
}

/** 8) UI events **/
$("nextBtn").onclick = () => nextRandom();
$("tapBtn").onclick  = () => { userGesture = true; $("tap").style.display="none"; nextRandom(); };

</script>
</body>
</html>
